name: ServiceNow Remediation Trigger

on:
  repository_dispatch:
    types: [trigger_remediation]

jobs:
  remediate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      security-events: write
      actions: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Create Remediation Branch
        id: create_branch
        run: |
          # 1. Config logic
          INC_NUM="${{ github.event.client_payload.incident_number }}"
          BRANCH_NAME="remediation/incident-$INC_NUM"
          echo "INC_NUM=$INC_NUM" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # 2. Create Branch & Commit
          git config --global user.name "ServiceNow Bot"
          git config --global user.email "bot@example.com"
          git checkout -b $BRANCH_NAME
          
          # 3. Make a change (Timestamp log AND touch vulnerable files)
          date >> remediation_trigger.log
          echo "// Trigger Scan" >> src/main/java/com/example/vuln/SQLInjection.java
          echo "# Trigger Scan" >> weak_crypto.py
          
          git add remediation_trigger.log src/main/java/com/example/vuln/SQLInjection.java weak_crypto.py
          git commit -m "Trigger Remediation for $INC_NUM (Touch vulnerable files)"
          
          # 4. Push Branch
          git push origin $BRANCH_NAME
          
          # 5. Capture SHA
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV

      - name: Install Dependencies
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # CodeQL Scan - Runs on the NEW commit (checked out above)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'java,python'

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          ref: refs/heads/${{ env.BRANCH_NAME }}
          sha: ${{ env.COMMIT_SHA }}

      # Black Duck Processing
      - name: Process Vulnerability Payload
        run: |
          echo "Processing incident ${{ env.INC_NUM }}"
          PAYLOAD='${{ toJSON(github.event.client_payload) }}'
          python remediation_worker.py --payload "$PAYLOAD" --output results.sarif

      - name: Upload BlackDuck SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: blackduck-import
          ref: refs/heads/${{ env.BRANCH_NAME }}
          sha: ${{ env.COMMIT_SHA }}

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create --title "Security Remediation: ${{ env.INC_NUM }}" --body "Automated remediation trigger for incident ${{ env.INC_NUM }}. <br> **CodeQL Scan**: Scanned commit ${{ env.COMMIT_SHA }}.<br> **Black Duck**: Attached alerts." --base main --head ${{ env.BRANCH_NAME }}
